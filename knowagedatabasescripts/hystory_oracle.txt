Insert in this file the history of DB Schema, only for Oracle Database
Every items must have:
- The Developer who has made the change
- The SQL script that updates the schema ( schema, index and FK )
- The Date

-- ##################################################################################################

-- 23.02.2015 Francesco Lucchi ORA_drop.sql: added DROP statement for SBI_OBJ_DATA_SET table.

-- 23.02.2015 Francesco Lucchi Athena_ORA_create.sql: fixed constraint definition for SBI_DATA_SET, SBI_PARUSE, SBI_PARAMETERS tables.

-- 23.02.2015 Francesco Lucchi: removed SBI_DOSSIER_* tables.

-- 06.05.2016 Alessandro Portosa: Renamed HIBERNATE_SEQUENCES and its fields with lowercase. It must be lowercase for Unix compatibility

--09.05.2016 Giulio Gavardi
ALTER TABLE SBI_OBJECTS ADD COLUMN LOCKED_BY_USER VARCHAR2(100) NULL;

-- 26.05.2016 Salvatore Lupo
ALTER TABLE SBI_ALERT ADD COLUMN SINGLE_EXECUTION VARCHAR2(1),
ADD COLUMN EVENT_BEFORE_TRIGGER_ACTION INTEGER;

-- 02.06.2016. Ana Tomic, Nikola Simovic
CREATE TABLE SBI_FUNCTIONS_ORGANIZER (
	FUNCT_ID INTEGER NOT NULL ,
	PARENT_FUNCT_ID INTEGER,
	NAME VARCHAR2 (40),
	DESCR VARCHAR2 (160),
	PATH VARCHAR2 (400),
	CODE VARCHAR2 (40) NOT NULL ,
	PROG INTEGER NOT NULL ,
	USER_IN              VARCHAR2(100) NOT NULL,
    USER_UP              VARCHAR2(100),
    USER_DE              VARCHAR2(100),
    TIME_IN              TIMESTAMP NOT NULL,
    TIME_UP              TIMESTAMP DEFAULT NULL,    
    TIME_DE              TIMESTAMP DEFAULT NULL,
    SBI_VERSION_IN       VARCHAR2(10),
    SBI_VERSION_UP       VARCHAR2(10),
    SBI_VERSION_DE       VARCHAR2(10),
    META_VERSION         VARCHAR2(100),
    ORGANIZATION         VARCHAR2(20),
CONSTRAINT XAK1SBI_FUNCTIONS_ORGANIZER UNIQUE (CODE, USER_IN),	
PRIMARY KEY (FUNCT_ID) 
);

CREATE TABLE SBI_OBJ_FUNC_ORGANIZER (
	BIOBJ_ID INTEGER NOT NULL ,
	FUNCT_ID INTEGER NOT NULL ,
	PROG INTEGER,
	USER_IN              VARCHAR2(100) NOT NULL,
    USER_UP              VARCHAR2(100),
    USER_DE              VARCHAR2(100),
    TIME_IN              TIMESTAMP NOT NULL,
    TIME_UP              TIMESTAMP DEFAULT NULL,    
    TIME_DE              TIMESTAMP DEFAULT NULL,
    SBI_VERSION_IN       VARCHAR2(10),
    SBI_VERSION_UP       VARCHAR2(10),
    SBI_VERSION_DE       VARCHAR2(10),
    META_VERSION         VARCHAR2(100),
    ORGANIZATION         VARCHAR2(20),
PRIMARY KEY (BIOBJ_ID,FUNCT_ID) 
);

ALTER TABLE SBI_FUNCTIONS_ORGANIZER ADD CONSTRAINT FK_SBI_FUNCTIONS_ORGANIZER_1 FOREIGN KEY (PARENT_FUNCT_ID) REFERENCES SBI_FUNCTIONS_ORGANIZER (FUNCT_ID);
ALTER TABLE SBI_OBJ_FUNC_ORGANIZER ADD CONSTRAINT FK_SBI_OBJ_FUNC_ORGANIZER_1 FOREIGN KEY (FUNCT_ID) REFERENCES SBI_FUNCTIONS_ORGANIZER (FUNCT_ID);
ALTER TABLE SBI_OBJ_FUNC_ORGANIZER ADD CONSTRAINT FK_SBI_OBJ_FUNC_ORGANIZER_2 FOREIGN KEY (BIOBJ_ID) REFERENCES SBI_OBJECTS (BIOBJ_ID) ON DELETE CASCADE;

-- 08.06.2016. Alessandro Portosa
ALTER TABLE SBI_CATALOG_FUNCTION ADD DESCRIPTION CLOB NOT NULL;

-- 09.06.2016 Vincenzo Gambino
ALTER TABLE SBI_PARUSE ADD COLUMN OPTIONS VARCHAR(4000) NULL DEFAULT NULL

--10.06.2016 Antonella Giachino: add hierarchy_name, level and member_name in SBI_GEO_MAP
ALTER TABLE  SBI_GEO_MAPS ADD HIERARCHY_NAME VARCHAR2(100);
ALTER TABLE  SBI_GEO_MAPS ADD LEVEL INTEGER;
ALTER TABLE  SBI_GEO_MAPS ADD MEMBER_NAME VARCHAR2(100);

-- 15.6.2016 Antonella: deleted WORSKSHEET engine - clean db from its user func and engines
alter table SBI_USER_FUNC disable constraint 'FK_PRODUCT_TYPE';
delete from SBI_USER_FUNC  where name = 'CreateWorksheetFromDatasetUserFunctionality';
alter table SBI_USER_FUNC enable constraint 'FK_PRODUCT_TYPE';

alter table SBI_OBJECTS disable constraint 'FK_SBI_OBJECTS_1';
alter table SBI_OBJECTS disable constraint 'FK_SBI_OBJECTS_2';
alter table SBI_OBJECTS disable constraint 'FK_SBI_OBJECTS_3';
DELETE FROM SBI_OBJECTS WHERE ENGINE_ID = (select engine_id from SBI_ENGINES  where name = 'Worksheet Engine');
alter table SBI_OBJECTS enable constraint 'FK_SBI_OBJECTS_1';
alter table SBI_OBJECTS enable constraint 'FK_SBI_OBJECTS_2';
alter table SBI_OBJECTS enable constraint 'FK_SBI_OBJECTS_3';

alter table SBI_ENGINES disable constraint 'FK_SBI_ENGINES_1';
alter table SBI_ENGINES disable constraint 'FK_SBI_ENGINES_2';
delete from SBI_ENGINES  where name = 'Worksheet Engine';
alter table SBI_ENGINES enable constraint 'FK_SBI_ENGINES_1';
alter table SBI_ENGINES enable constraint 'FK_SBI_ENGINES_2';
-- not fk to disable for domains:
delete from SBI_DOMAINS where value_cd = 'WORKSHEET';

-- 22.06.2016 Antonella: rename LEVEL column to NUM_LEVEL
 ALTER TABLE SBI_GEO_MAPS RENAME COLUMN LEVEL TO NUM_LEVEL;
 
-- 27.06.2016 Francesco Lucchi: grant functionalities ConfigManagement & DomainManagement to superadmin only
DELETE FROM SBI_ROLE_TYPE_USER_FUNC WHERE USER_FUNCT_ID IN (SELECT USER_FUNCT_ID FROM SBI_USER_FUNC WHERE NAME = 'ConfigManagement');
DELETE FROM SBI_ROLE_TYPE_USER_FUNC WHERE USER_FUNCT_ID IN (SELECT USER_FUNCT_ID FROM SBI_USER_FUNC WHERE NAME = 'DomainManagement');
DELETE FROM SBI_USER_FUNC WHERE NAME = 'ConfigManagement';
DELETE FROM SBI_USER_FUNC WHERE NAME = 'DomainManagement';


-- 05.07.2016 Vincenzo Gambino: add column FILE_MODEL in SBI_META_MODELS_VERSIONS
ALTER TABLE SBI_META_MODELS_VERSIONS MODIFY CONTENT BLOB;	
ALTER TABLE SBI_META_MODELS_VERSIONS ADD FILE_MODEL BLOB NULL;


-- 13.07.2016 Alessandro Piovani: add column ADDITIONAL_INFO in SBI_OBJ_METACONTENT
ALTER TABLE SBI_OBJ_METACONTENTS ADD ADDITIONAL_INFO VARCHAR2(255) DEFAULT NULL;

-- 14.07.2016 Alessandro Piovani: added some columns an constraints to SBI_CATALOG_FUNCTIONS table 
ALTER TABLE SBI_CATALOG_FUNCTION 
ADD OWNER 	VARCHAR(50) NOT NULL,
ADD KEYWORDS VARCHAR(255) DEFAULT NULL;

ALTER TABLE SBI_CATALOG_FUNCTION 
ADD LABEL VARCHAR(50) NOT NULL;

ALTER TABLE SBI_CATALOG_FUNCTION
ADD CONSTRAINT UNIQUE_LABEL_ORG UNIQUE (LABEL,ORGANIZATION);

ALTER TABLE SBI_CATALOG_FUNCTION 
ADD TYPE VARCHAR(50) DEFAULT NULL;

CREATE TABLE SBI_WHATIF_WORKFLOW(
	ID INTEGER,
    MODEL_ID INTEGER,
    USER_ID INTEGER,
    SEQUENCE INTEGER,
    STATE VARCHAR2(20),
    NOTES VARCHAR2(100),
    INFO VARCHAR2(100),
    USER_IN              VARCHAR2(100) NOT NULL,
    USER_UP VARCHAR2(100),
    USER_DE VARCHAR2(100),
    TIME_IN              TIMESTAMP NOT NULL,
    TIME_UP              TIMESTAMP DEFAULT NULL,    
    TIME_DE              TIMESTAMP DEFAULT NULL,
    SBI_VERSION_IN VARCHAR2(10),
    SBI_VERSION_UP VARCHAR2(10),
    SBI_VERSION_DE VARCHAR2(10),
    ORGANIZATION VARCHAR2(20),
    PRIMARY KEY (ID)
);

ALTER TABLE SBI_WHATIF_WORKFLOW 				ADD CONSTRAINT FK_SBI_MODEL_WORKFLOW			FOREIGN KEY (MODEL_ID) 			REFERENCES SBI_ARTIFACTS(ID)					ON DELETE CASCADE;
ALTER TABLE SBI_WHATIF_WORKFLOW 				ADD CONSTRAINT FK_SBI_USER_WORKFLOW			FOREIGN KEY (USER_ID) 				REFERENCES SBI_USER(ID) ON DELETE CASCADE;

-- 09.08.2016 Alberto Ghedin: refactoring whatif start actions
update SBI_ENGINES set MAIN_URL="/knowagewhatifengine/restful-services/olap/startolap" where label = "knowageolapengine";
update SBI_ENGINES set MAIN_URL="/knowagewhatifengine/restful-services/olap/startwhatif" where label = "knowagewhatifengine";

-- 31.08.2016 Marco Cortella: changed foreign keys (delete policy) used by Business Model Catalog and Metadata import
ALTER TABLE SBI_META_TABLE_BC
	DROP CONSTRAINT FK_SBI_META_TABLE_BC_2;
ALTER TABLE SBI_META_TABLE_BC
	ADD CONSTRAINT FK_SBI_META_TABLE_BC_2 FOREIGN KEY (BC_ID) REFERENCES SBI_META_BC (BC_ID) ON DELETE CASCADE;

ALTER TABLE SBI_META_BC
	DROP CONSTRAINT FK_SBI_META_BC_1;
ALTER TABLE SBI_META_BC
	ADD CONSTRAINT FK_SBI_META_BC_1 FOREIGN KEY (MODEL_ID) REFERENCES SBI_META_MODELS (ID) ON DELETE CASCADE;
	
ALTER TABLE SBI_META_BC_ATTRIBUTE
	DROP CONSTRAINT FK_SBI_META_BC_ATTRIBUTE_1;
ALTER TABLE SBI_META_BC_ATTRIBUTE
	ADD CONSTRAINT FK_SBI_META_BC_ATTRIBUTE_1 FOREIGN KEY (BC_ID) REFERENCES SBI_META_BC (BC_ID) ON DELETE CASCADE;	
	
ALTER TABLE SBI_META_BC_ATTRIBUTE
	DROP CONSTRAINT FK_SBI_META_BC_ATTRIBUTE_2;
ALTER TABLE SBI_META_BC_ATTRIBUTE
	ADD CONSTRAINT FK_SBI_META_BC_ATTRIBUTE_2 FOREIGN KEY (COLUMN_ID) REFERENCES SBI_META_TABLE_COLUMN (COLUMN_ID) ON DELETE CASCADE;	
	
ALTER TABLE SBI_META_DS_BC
	DROP CONSTRAINT FK_SBI_META_DS_BC_2;
ALTER TABLE SBI_META_DS_BC
	ADD CONSTRAINT FK_SBI_META_DS_BC_2 FOREIGN KEY (BC_ID) REFERENCES SBI_META_BC (BC_ID) ON DELETE CASCADE;
	

-- 14.09.2016 Alessandro Piovani: add url, remote columns to SBI_CATALOG_FUNCTIONS and make SCRIPT field nullable

ALTER TABLE SBI_CATALOG_FUNCTION ADD COLUMN REMOTE SMALLINT DEFAULT 0;
ALTER TABLE SBI_CATALOG_FUNCTION ADD COLUMN URL VARCHAR(100);
ALTER TABLE SBI_CATALOG_FUNCTION CHANGE COLUMN SCRIPT SCRIPT TEXT NULL;

-- 14.10.2016 S.Lupo: fixed numeric precision of threshold value
ALTER TABLE SBI_KPI_THRESHOLD_VALUE MODIFY MIN_VALUE NUMBER(18,5);
ALTER TABLE SBI_KPI_THRESHOLD_VALUE MODIFY MAX_VALUE NUMBER(18,5);	

-- 7.11.2016 Giulio Gavardi
ALTER TABLE SBI_OUTPUT_PARAMETER ADD COLUMN IS_USER_DEFINED SMALLINT NULL DEFAULT 0;

-- Alessandro Piovani
CREATE TABLE SBI_FUNCTION_INPUT_FILE (
	FUNCTION_ID INTEGER	NOT NULL,
	FILE_NAME VARCHAR2(100)	NOT NULL, 
	FILE_CONTENT BLOB		DEFAULT NULL,
	ALIAS VARCHAR2(45)		DEFAULT NULL,
	USER_IN 				VARCHAR2(100) NOT NULL,
  	USER_UP 				VARCHAR2(100) DEFAULT NULL,
  	USER_DE 				VARCHAR2(100) DEFAULT NULL,
  	TIME_IN 				TIMESTAMP NOT NULL,
  	TIME_UP 				TIMESTAMP DEFAULT NULL,
  	TIME_DE 				TIMESTAMP DEFAULT NULL,
  	SBI_VERSION_IN 			VARCHAR2(10) DEFAULT NULL,
  	SBI_VERSION_UP 			VARCHAR2(10) DEFAULT NULL,
  	SBI_VERSION_DE 			VARCHAR2(10) DEFAULT NULL,
  	ORGANIZATION 			VARCHAR2(20) DEFAULT NULL,
	PRIMARY KEY (FUNCTION_ID, FILE_NAME)
);

ALTER TABLE SBI_FUNCTION_INPUT_FILE ADD CONSTRAINT FK_FUNCTION_INPUT_FILES_2 FOREIGN KEY (FUNCTION_ID) REFERENCES SBI_CATALOG_FUNCTION(FUNCTION_ID);

--30.11.2016 Ana Tomic

CREATE TABLE SBI_ACCESSIBILITY_PREFERENCES (
	 ID INT(11) UNSIGNED NOT NULL,
	 USER_ID INT(11) NOT NULL,
	 ENABLE_UIO TINYINT(1) NOT NULL,
	 ENABLE_RROBOBRAILLE TINYINT(1) NULL DEFAULT NULL,
	 ENABLE_GRAPH_SONIFICATION TINYINT(1) NULL DEFAULT NULL,
	 ENABLE_VOICE TINYINT(1) NULL DEFAULT NULL,
	 PREFERENCES TEXT NULL,
	 USER_IN VARCHAR(100) NULL DEFAULT NULL,
	 USER_UP VARCHAR(100) NULL DEFAULT NULL,
	 USER_DE VARCHAR(100) NULL DEFAULT NULL,
	 TIME_IN TIMESTAMP NULL DEFAULT CURRENT_TIMESTAMP,
	 TIME_UP TIMESTAMP NULL DEFAULT CURRENT_TIMESTAMP,
	 TIME_DE TIMESTAMP NULL DEFAULT CURRENT_TIMESTAMP,
	 SBI_VERSION_IN VARCHAR(10) NULL DEFAULT NULL,
	 SBI_VERSION_UP VARCHAR(10) NULL DEFAULT NULL,
	 SBI_VERSION_DE VARCHAR(10) NULL DEFAULT NULL,
	 ORGANIZATION VARCHAR(20) NULL DEFAULT NULL,
	 INDEX FK_SBI_ACCESSIBILITY_PREFERENCES_SBI_USER (USER_ID),
	PRIMARY KEY (ID), 
	CONSTRAINT FK_SBI_ACCESSIBILITY_PREFERENCES_SBI_USER FOREIGN KEY (USER_ID) REFERENCES SBI_USER (ID) ON UPDATE CASCADE ON DELETE CASCADE
);

-- 10.02.2017 ALberto Ghedin 
-- added columns that link a snapshot with schedulation

ALTER TABLE SBI_SNAPSHOTS ADD SCHEDULATION VARCHAR2(100);
ALTER TABLE SBI_SNAPSHOTS ADD SCHEDULER VARCHAR2(100);
ALTER TABLE SBI_SNAPSHOTS ADD SCHEDULATION_START INTEGER;
ALTER TABLE SBI_SNAPSHOTS ADD SEQUENCE INTEGER;

-- 22.02.2017
-- added uniquiness constraint for kpi target

ALTER TABLE SBI_KPI_TARGET ADD CONSTRAINT XAK1SBI_KPI_TARGET UNIQUE (
	NAME,
	ORGANIZATION
);

-- 02.03.2017 Dragan Pirkovic 
-- changed path for chart document execution

UPDATE SBI_ENGINES SET MAIN_URL = '/knowagecockpitengine/api/1.0/chart/pages/execute' WHERE LABEL = 'knowagechartengine';

-- 20.03.2017 Marco Cortella
-- added TYPE column for SBI_CROSS_NAVIGATION
ALTER TABLE SBI_CROSS_NAVIGATION ADD TYPE INTEGER;
UPDATE SBI_CROSS_NAVIGATION SET TYPE=0;

-- 09.06.2017 Alessandro Portosa
-- changed package for Alert actions
UPDATE SBI_ALERT_ACTION SET CLASS_NAME='it.eng.knowage.enterprise.tools.alert.action.ExecuteETLDocument' WHERE NAME = 'Execute ETL Document';
UPDATE SBI_ALERT_ACTION SET CLASS_NAME='it.eng.knowage.enterprise.tools.alert.action.SendMail' WHERE NAME = 'Send mail';

-- 13.07.2017 Francesco Lucchi
-- fix definition length, limiting varchars to 4000 (Oracle upper bound)
ALTER TABLE SBI_KPI_KPI CHANGE COLUMN DEFINITION DEFINITION VARCHAR(4000) NOT NULL;
ALTER TABLE SBI_KPI_RULE CHANGE COLUMN DEFINITION DEFINITION VARCHAR(4000) NOT NULL;

-- 28.09.2017 Dragan Pirkovic
-- adding foreign key from sbi.metamodel.DATA_SOURCE_ID to sbi_data_source.DS_ID
ALTER TABLE SBI_META_MODEL	ADD CONSTRAINT FK_META_MODELS_DS_ID	 FOREIGN KEY (DATA_SOURCE_ID) 	REFERENCES SBI_DATA_SOURCE(DS_ID);

-- 05.10.2017 Alessandro Portosa
-- change column type of SBI_AUDIT.DOC_PARAMETERS from VARCHAR2(4000) to CLOB: it must handle all execution parameters and values
ALTER TABLE SBI_META_MODEL	ADD CONSTRAINT FK_META_MODELS_DS_ID	 FOREIGN KEY (DATA_SOURCE_ID) 	REFERENCES SBI_DATA_SOURCE(DS_ID);	